# FastAPI Telegram Service

Welcome to the **FastAPI Telegram Service**! 🚀 This project is a FastAPI-based service that processes and stores JSON requests, sends messages to Telegram, and includes a role-based access control system integrated with PostgreSQL.

## Features ✨

1. **Role-based Access Control** 🔐
   - **Admin**: Full access to all records.
   - **Manager**: Access to records of their assigned users.
   - **User**: Access only to their own records.
   - Authentication and authorization implemented with JWT tokens.

2. **JSON Request Handling** 📨
   - Accepts POST requests with JSON payloads:
     ```json
     {
         "bottoken": "xxxxxxxx",
         "chatid": 123123123,
         "message": "foo bar"
     }
     ```
   - Saves the request, response, and author details to the database.

3. **Telegram Integration** 🤖
   - Sends messages to Telegram using the provided `bottoken` and `chatid`.
   - Stores the Telegram API response in the database.

4. **PostgreSQL Database** 🗂️
   - Stores user details, roles, and requests with proper relationships.

5. **Comprehensive API with Swagger UI** 📘
   - FastAPI-generated documentation available at `/docs`.

6. **Easy Deployment and Testing** 🛠️
   - Includes database dump for testing.
   - Readable and maintainable codebase.

## Installation 🖥️

1. Clone the repository:
   ```bash
   git clone https://github.com/DmytroHlazyrin/Telegram_bot_manager.git
   cd Telegram_bot_manager
   ```

2. Install dependencies:
   ```bash
   pip install -r requirements.txt
   ```
3. Create a virtual environment and install dependencies

   ```bash
   python -m venv venv
   source venv/bin/activate  # For Unix-based systems
   # or
   venv\Scripts\activate  # For Windows
   ```

4. Set up the database:
   - Ensure you have PostgreSQL installed and running.
   - Create a database and configure the connection in the `.env` file.

5. Apply migrations:
   ```bash
   alembic upgrade head
   ```

6. Run the development server:
   ```bash
   uvicorn app.main:app --reload
   ```

7. Create superuser (admin):
   ```bash
   python create_user_script.py
   ```
   You could log in with credentials:
   - email: "admin@example.com"
   - password: "string"
   
## Run with Docker 🐋
   - Clone the repository
   ```bash
   git clone https://github.com/DmytroHlazyrin/Telegram_bot_manager.git
   cd Telegram_bot_manager
   ```
   - Build and run project
   ```bash
   docker-compose up --build
   ```
   - To run container in background:
   ```bash
   docker-compose up --build - d
   ```
   - Populate db with data for testing:
   ```bash
   docker exec -it fastapi-app /bin/bash
   python populate_database.py
   ```
You could log in with credentials:
   - email: "admin@example.com" / "manager1@example.com" / "user1@example.com"
   - password: "string"

## API Endpoints 🛡️

### Authentication
- **POST** `/auth/login` - Login to receive a JWT token with cookie transport.
- **POST** `/auth/logout` - Logout.
- **POST** `/auth/register` - Register a new user.

### User Management
- **GET** `/users` - Retrieve all users (Admin sees all, manager sees only his subordinates).
- **GET** `/users/{user_id}` - Retrieve a user by ID (Same as above).
- **GET** `/users/me` - Retrieve current user details.
- **PUT** `/users/{user_id}/role` - Update user role (Admin only).
- **PUT** `/users/{user_id}/assign_manager` - Assign a manager to a user (Admin only).

### Request Handling
- **POST** `/requests` - Send a request to Telegram and store it.
- **GET** `/requests` - Retrieve all requests (Admin sees all, manager sees only his subordinates requests).
- **GET** `/users/{user_id}/requests` - Retrieve requests of a specific user (Same as above).

## Usage 🚀

### Sending a Telegram Request
1. Authenticate and obtain a JWT token.
2. Send a POST request to `/requests` with the following payload:
   ```json
   {
       "bottoken": "your-bot-token",
       "chatid": "your-chat-id",
       "message": "Hello from FastAPI!"
   }
   ```
3. View the saved request and Telegram response in the database or via API.

## Testing 🧪

1. Load the provided database dump into your PostgreSQL instance.
2. Use tools like [Postman](https://www.postman.com/) or `curl` to test the endpoints.


## Documentation 📚

Visit `/docs` for interactive API documentation generated by Swagger UI. Alternatively, `/redoc` is available for ReDoc documentation.

## Environment Variables ⚙️

Create a `.env` file in the project root with the following keys:
```env
DATABASE_URL=postgresql://<username>:<password>@localhost/<database>
SECRET_KEY=your-secret-key
```

## Contributing 🤝

Feel free to fork the repository and submit pull requests! Contributions are welcome. 🙌

## License 📜

This project is licensed under the MIT License.

---

Enjoy using the **FastAPI Telegram Service**! 🚀
